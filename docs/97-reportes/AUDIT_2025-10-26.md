# 🔍 AUDITORÍA TÉCNICA COMPLETA - UNS-ClaudeJP 5.0
**Fecha**: 2025-10-26
**Estado**: ⚠️ FUNCIONAL PERO REQUIERE LIMPIEZA URGENTE

---

## 📊 RESUMEN EJECUTIVO

| Aspecto | Puntuación | Estado |
|---------|-----------|--------|
| **Duplicación de Código** | 5/10 | 🔴 CRÍTICO |
| **Seguridad** | 4/10 | 🔴 CRÍTICO |
| **Arquitectura** | 6/10 | 🟡 ALTO |
| **Performance** | 6/10 | 🟡 ALTO |
| **Mantenibilidad** | 4/10 | 🔴 CRÍTICO |
| **Documentación** | 5/10 | 🟡 ALTO |

**Código Total Duplicado**: 2,500+ líneas (podría reducirse a 300 líneas)
**Archivos Muertos**: 35+ archivos
**Vulnerabilidades de Seguridad**: 5 CRÍTICAS, 3 ALTAS
**Esfuerzo de Limpieza**: ~91 horas

---

## 🚨 PROBLEMAS CRÍTICOS (FIX PRIMERO)

### 1. DUPLICACIÓN MASIVA DE SCRIPTS (1,600+ líneas)

**Problema**: 9 scripts que hacen lo mismo - usuarios no saben cuál usar

| Script | Líneas | Propósito | ACCIÓN |
|--------|--------|----------|--------|
| `extract_access_attachments.py` | 432 | Extraer fotos | **MANTENER** |
| `import_photos_from_json.py` | 179 | Importar JSON | **MANTENER** |
| `import_photos_by_name.py` | 232 | Importar por nombre | 🗑️ ELIMINAR |
| `import_photos_from_access.py` | 220 | Importar Access | 🗑️ ELIMINAR |
| `import_photos_from_access_v2.py` | 136 | Versión vieja | 🗑️ ELIMINAR |
| `import_photos_from_access_corrected.py` | 207 | Corregida | 🗑️ ELIMINAR |
| `import_photos_from_access_simple.py` | 154 | Simplificada | 🗑️ ELIMINAR |
| `extract_access_with_photos.py` | 208 | Extrae todo | 🗑️ ELIMINAR |
| `import_access_candidates_with_photos.py` | 272 | Candidatos+fotos | 🗑️ ELIMINAR |

**Total a eliminar**: 1,429 líneas de código duplicado

---

### 2. CANDIDATOS: 5 SCRIPTS REDUNDANTES (960+ líneas)

| Script | Líneas | Estado | ACCIÓN |
|--------|--------|--------|--------|
| `import_data.py` | 692 | ✅ Funciona | **MANTENER** |
| `import_real_candidates.py` | 78 | ❌ Incompleto | 🗑️ ELIMINAR |
| `import_real_candidates_final.py` | 189 | ❌ Incompleto | 🗑️ ELIMINAR |
| `import_candidates_full.py` | 243 | ❌ Incompleto | 🗑️ ELIMINAR |
| `import_candidates_complete.py` | 192 | ❌ Incompleto | 🗑️ ELIMINAR |
| `import_demo_candidates.py` | 227 | ✅ Funciona | **MANTENER** |

**Total a eliminar**: ~893 líneas

---

### 3. 🔴 CREDENCIALES HARDCODEADAS (CRÍTICO)

**12+ scripts contienen contraseña en plaintext**:

```python
# ❌ CRÍTICO: Visible en todos estos archivos
POSTGRES_URL = "postgresql://uns_admin:57UD10R@localhost:5432/uns_claudejp"
```

**Riesgo**: Si repo se filtra, base de datos completa comprometida

**Archivos afectados**:
- `import_photos_by_name.py`
- `import_photos_from_json.py`
- `import_photos_from_access*.py` (4 versiones)
- `sync_employee_data_advanced.py`
- `debug_photo_extraction.py`
- `debug_photo_matching.py`
- `extract_access_with_photos.py`
- `match_candidates_with_employees.py`
- `populate_hakensaki_shain_ids.py`

---

### 4. 🔴 OTROS RIESGOS CRÍTICOS DE SEGURIDAD

#### SQL Injection (database.py:38)
```python
# VULNERABLE:
result = db.execute(text(f"SELECT COUNT(*) FROM {table_name}"))
```

#### File Upload Sin Validación (candidates.py:500+)
```python
# VULNERABLE:
# - Sin validación de tipo
# - Sin límite de tamaño
# - Sin sanitización de filename
# - Path traversal posible
```

#### Contraseñas Débiles por Defecto
```python
# create_admin_user.py
password_hash=AuthService.get_password_hash('admin123')  # ❌ DÉBIL!
```

---

## 🧹 ARCHIVOS MUERTOS A ELIMINAR

### En Raíz (10 archivos)
```
❌ ]                                    (archivo vacío?)
❌ extract_attachments_*.log            (3 archivos, 152KB)
❌ test.js, test-login.mjs, test-console.js
❌ run-tests.js, run-tests-fixed.js
```

### En backend/scripts/ (35+ scripts muertos)
```
Diagnósticos (8 scripts):
❌ explore_access_db.py
❌ explore_access_columns.py
❌ list_access_tables.py
❌ find_photos_in_access_all_tables.py
❌ scan_all_columns_for_binary.py
❌ check_for_embedded_photos.py
❌ check_photo_column.py
❌ debug_*.py (5 archivos)

Importaciones Viejas (5 scripts):
❌ import_real_candidates.py
❌ import_real_candidates_final.py
❌ import_candidates_full.py
❌ import_candidates_complete.py
❌ import_employees_as_candidates.py

Verificaciones Duplicadas (4 scripts):
❌ verify_system.py (267 líneas)
❌ full_verification.py (240 líneas)
❌ verify_all_photos.py
❌ test_database_connection.py

Migraciones Antiguas (3 scripts):
❌ migrate_candidates_rirekisho.py
❌ relink_factories.py
❌ assign_factory_ids.py
```

---

## 📈 PROBLEMAS DE ARQUITECTURA

### N+1 Query Problem (candidatos.py:200+)
```python
# ❌ INEFICIENTE: 1,001 queries para 1,000 candidatos
candidates = db.query(Candidate).all()
for c in candidates:
    print(c.employee.factory.name)  # ← Query por cada iteración!
```

**Solución**: Usar `joinedload()`

### Sin Paginación
```python
# ❌ PROBLEMA: Descarga TODO (podría ser 100,000+ registros)
@router.get("/")
def list_candidates(db):
    return db.query(Candidate).all()
```

### Sin Índices de Base de Datos
```sql
-- Estas columnas NUNCA se usan en WHERE sin índices:
candidates.full_name_kanji       -- Sin índice
candidates.full_name_kana        -- Sin índice
employees.hakensaki_shain_id     -- Sin índice
timer_cards.date                 -- Sin índice (¡date range queries!)
```

### Problema de Direcciones (5 campos conflictivos)
```python
candidates.address              # Cuál es canónica?
candidates.address_banchi       # ?
candidates.address_building     # ?
candidates.current_address      # ?
candidates.registered_address   # ?
```

---

## ✅ LISTA DE ACCIONES

### SEMANA 1: CRÍTICO (24 horas)
- [ ] **Eliminar credenciales hardcodeadas** (4h)
  - Crear `backend/.env.example`
  - Usar `python-dotenv`
  - Actualizar 12 scripts

- [ ] **Fix SQL Injection** (2h)
  - database.py → usar Table reflection

- [ ] **Fix File Upload Validation** (3h)
  - Validación de tipo (solo imágenes)
  - Límite de tamaño (10MB máx)
  - Sanitización de filename

- [ ] **Cambiar contraseñas por defecto** (1h)
  - Generar aleatorias en setup
  - Solicitar cambio en primer login

- [ ] **Eliminar archivos muertos en raíz** (2h)
  - Mover .py a `backend/scripts/`
  - Mover .bat a `scripts/`

### SEMANA 2: CONSOLIDACIÓN (40 horas)
- [ ] **Consolidar imports de fotos** (12h)
  - Crear `unified_photo_import.py`
  - CLI mode: extract, import, verify
  - Dry-run, checkpoint/resume

- [ ] **Consolidar verificaciones** (10h)
  - Crear `verify.py` con subcomandos
  - Eliminar 4 scripts duplicados

- [ ] **Archivar scripts diagnosticados** (5h)
  - Mover a `docs/archive/`
  - Documentar qué hacía cada uno

- [ ] **Renombrar migrations** (3h)
  - Cambiar a numeración Alembic
  - Verificar orden de ejecución

- [ ] **Limpiar LIXO/** (2h)
  - Revisar si aún necesario
  - Archivar o eliminar

- [ ] **Testing exhaustivo** (8h)

### SEMANA 3: PERFORMANCE (32 horas)
- [ ] **Fix N+1 queries** (8h)
  - Auditar candidatos.py
  - Usar joinedload() sistemáticamente

- [ ] **Agregar paginación** (6h)
  - Implementar límite/offset
  - Actualizar frontend

- [ ] **Agregar índices de BD** (2h)
  - full_name_kanji, full_name_kana
  - hakensaki_shain_id
  - date ranges

- [ ] **Mejorar manejo de errores** (8h)
  - Logging consistente
  - Recovery graceful

- [ ] **Documentación** (8h)

---

## 📋 SCRIPTS A MANTENER

### Backend Scripts (CORE)
```
✅ MANTENER SIEMPRE:
├── import_data.py                      (Candidatos - PRINCIPAL)
├── import_demo_candidates.py           (Demo data)
├── extract_access_attachments.py       (Extrae fotos - PRINCIPAL)
├── import_photos_from_json.py          (Importa JSON - PRINCIPAL)
├── auto_extract_photos_from_databasejp.py  (Auto-búsqueda)
├── sync_employee_data_advanced.py      (Sincroniza empleados)
├── create_admin_user.py                (Setup inicial)
├── verify_data.py                      (Verificación)
└── [otros scripts activos no duplicados]

🗑️ ELIMINAR:
├── import_photos_by_name.py            (Redundante)
├── import_photos_from_access*.py       (4 versiones redundantes)
├── import_real_candidates*.py          (3 versiones incompletas)
├── import_candidates_*.py              (2 versiones incompletas)
├── verify_*.py                         (Consolidar)
├── debug_*.py                          (5 scripts debug)
├── explore_access_*.py                 (8 diagnósticos)
└── [34 más scripts muertos...]
```

---

## 📊 IMPACTO POST-LIMPIEZA

| Métrica | ANTES | DESPUÉS | MEJORA |
|---------|-------|---------|--------|
| Líneas de código duplicado | 2,500+ | ~200 | **92% ↓** |
| Archivos muertos | 35+ | 0 | **100% ↓** |
| Scripts confusos | 9 | 1 | **89% ↓** |
| Vulnerabilidades críticas | 5 | 0 | **100% ↓** |
| Puntuación seguridad | 4/10 | 9/10 | **+125%** |
| Mantenibilidad | 4/10 | 8/10 | **+100%** |

---

## 🎯 RECOMENDACIÓN FINAL

**PRIORIDAD 1 (Hacer primero)**: Seguridad crítica
- Eliminar credenciales hardcodeadas
- Fix SQL injection
- Fix file upload validation
- Cambiar contraseñas débiles

**PRIORIDAD 2 (Hacer después)**: Consolidación
- Eliminar duplicados
- Archivar muertos
- Unificar interface

**PRIORIDAD 3 (Nice-to-have)**: Optimización
- Performance fixes
- Índices de BD
- Paginación

---

**Documento generado**: 2025-10-26
**Próximo paso**: Empezar con PRIORIDAD 1 (Seguridad)
