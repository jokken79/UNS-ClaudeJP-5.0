# ğŸ” AUDITORÃA TÃ‰CNICA COMPLETA - UNS-ClaudeJP 5.0
**Fecha**: 2025-10-26
**Estado**: âš ï¸ FUNCIONAL PERO REQUIERE LIMPIEZA URGENTE

---

## ğŸ“Š RESUMEN EJECUTIVO

| Aspecto | PuntuaciÃ³n | Estado |
|---------|-----------|--------|
| **DuplicaciÃ³n de CÃ³digo** | 5/10 | ğŸ”´ CRÃTICO |
| **Seguridad** | 4/10 | ğŸ”´ CRÃTICO |
| **Arquitectura** | 6/10 | ğŸŸ¡ ALTO |
| **Performance** | 6/10 | ğŸŸ¡ ALTO |
| **Mantenibilidad** | 4/10 | ğŸ”´ CRÃTICO |
| **DocumentaciÃ³n** | 5/10 | ğŸŸ¡ ALTO |

**CÃ³digo Total Duplicado**: 2,500+ lÃ­neas (podrÃ­a reducirse a 300 lÃ­neas)
**Archivos Muertos**: 35+ archivos
**Vulnerabilidades de Seguridad**: 5 CRÃTICAS, 3 ALTAS
**Esfuerzo de Limpieza**: ~91 horas

---

## ğŸš¨ PROBLEMAS CRÃTICOS (FIX PRIMERO)

### 1. DUPLICACIÃ“N MASIVA DE SCRIPTS (1,600+ lÃ­neas)

**Problema**: 9 scripts que hacen lo mismo - usuarios no saben cuÃ¡l usar

| Script | LÃ­neas | PropÃ³sito | ACCIÃ“N |
|--------|--------|----------|--------|
| `extract_access_attachments.py` | 432 | Extraer fotos | **MANTENER** |
| `import_photos_from_json.py` | 179 | Importar JSON | **MANTENER** |
| `import_photos_by_name.py` | 232 | Importar por nombre | ğŸ—‘ï¸ ELIMINAR |
| `import_photos_from_access.py` | 220 | Importar Access | ğŸ—‘ï¸ ELIMINAR |
| `import_photos_from_access_v2.py` | 136 | VersiÃ³n vieja | ğŸ—‘ï¸ ELIMINAR |
| `import_photos_from_access_corrected.py` | 207 | Corregida | ğŸ—‘ï¸ ELIMINAR |
| `import_photos_from_access_simple.py` | 154 | Simplificada | ğŸ—‘ï¸ ELIMINAR |
| `extract_access_with_photos.py` | 208 | Extrae todo | ğŸ—‘ï¸ ELIMINAR |
| `import_access_candidates_with_photos.py` | 272 | Candidatos+fotos | ğŸ—‘ï¸ ELIMINAR |

**Total a eliminar**: 1,429 lÃ­neas de cÃ³digo duplicado

---

### 2. CANDIDATOS: 5 SCRIPTS REDUNDANTES (960+ lÃ­neas)

| Script | LÃ­neas | Estado | ACCIÃ“N |
|--------|--------|--------|--------|
| `import_data.py` | 692 | âœ… Funciona | **MANTENER** |
| `import_real_candidates.py` | 78 | âŒ Incompleto | ğŸ—‘ï¸ ELIMINAR |
| `import_real_candidates_final.py` | 189 | âŒ Incompleto | ğŸ—‘ï¸ ELIMINAR |
| `import_candidates_full.py` | 243 | âŒ Incompleto | ğŸ—‘ï¸ ELIMINAR |
| `import_candidates_complete.py` | 192 | âŒ Incompleto | ğŸ—‘ï¸ ELIMINAR |
| `import_demo_candidates.py` | 227 | âœ… Funciona | **MANTENER** |

**Total a eliminar**: ~893 lÃ­neas

---

### 3. ğŸ”´ CREDENCIALES HARDCODEADAS (CRÃTICO)

**12+ scripts contienen contraseÃ±a en plaintext**:

```python
# âŒ CRÃTICO: Visible en todos estos archivos
POSTGRES_URL = "postgresql://uns_admin:57UD10R@localhost:5432/uns_claudejp"
```

**Riesgo**: Si repo se filtra, base de datos completa comprometida

**Archivos afectados**:
- `import_photos_by_name.py`
- `import_photos_from_json.py`
- `import_photos_from_access*.py` (4 versiones)
- `sync_employee_data_advanced.py`
- `debug_photo_extraction.py`
- `debug_photo_matching.py`
- `extract_access_with_photos.py`
- `match_candidates_with_employees.py`
- `populate_hakensaki_shain_ids.py`

---

### 4. ğŸ”´ OTROS RIESGOS CRÃTICOS DE SEGURIDAD

#### SQL Injection (database.py:38)
```python
# VULNERABLE:
result = db.execute(text(f"SELECT COUNT(*) FROM {table_name}"))
```

#### File Upload Sin ValidaciÃ³n (candidates.py:500+)
```python
# VULNERABLE:
# - Sin validaciÃ³n de tipo
# - Sin lÃ­mite de tamaÃ±o
# - Sin sanitizaciÃ³n de filename
# - Path traversal posible
```

#### ContraseÃ±as DÃ©biles por Defecto
```python
# create_admin_user.py
password_hash=AuthService.get_password_hash('admin123')  # âŒ DÃ‰BIL!
```

---

## ğŸ§¹ ARCHIVOS MUERTOS A ELIMINAR

### En RaÃ­z (10 archivos)
```
âŒ ]                                    (archivo vacÃ­o?)
âŒ extract_attachments_*.log            (3 archivos, 152KB)
âŒ test.js, test-login.mjs, test-console.js
âŒ run-tests.js, run-tests-fixed.js
```

### En backend/scripts/ (35+ scripts muertos)
```
DiagnÃ³sticos (8 scripts):
âŒ explore_access_db.py
âŒ explore_access_columns.py
âŒ list_access_tables.py
âŒ find_photos_in_access_all_tables.py
âŒ scan_all_columns_for_binary.py
âŒ check_for_embedded_photos.py
âŒ check_photo_column.py
âŒ debug_*.py (5 archivos)

Importaciones Viejas (5 scripts):
âŒ import_real_candidates.py
âŒ import_real_candidates_final.py
âŒ import_candidates_full.py
âŒ import_candidates_complete.py
âŒ import_employees_as_candidates.py

Verificaciones Duplicadas (4 scripts):
âŒ verify_system.py (267 lÃ­neas)
âŒ full_verification.py (240 lÃ­neas)
âŒ verify_all_photos.py
âŒ test_database_connection.py

Migraciones Antiguas (3 scripts):
âŒ migrate_candidates_rirekisho.py
âŒ relink_factories.py
âŒ assign_factory_ids.py
```

---

## ğŸ“ˆ PROBLEMAS DE ARQUITECTURA

### N+1 Query Problem (candidatos.py:200+)
```python
# âŒ INEFICIENTE: 1,001 queries para 1,000 candidatos
candidates = db.query(Candidate).all()
for c in candidates:
    print(c.employee.factory.name)  # â† Query por cada iteraciÃ³n!
```

**SoluciÃ³n**: Usar `joinedload()`

### Sin PaginaciÃ³n
```python
# âŒ PROBLEMA: Descarga TODO (podrÃ­a ser 100,000+ registros)
@router.get("/")
def list_candidates(db):
    return db.query(Candidate).all()
```

### Sin Ãndices de Base de Datos
```sql
-- Estas columnas NUNCA se usan en WHERE sin Ã­ndices:
candidates.full_name_kanji       -- Sin Ã­ndice
candidates.full_name_kana        -- Sin Ã­ndice
employees.hakensaki_shain_id     -- Sin Ã­ndice
timer_cards.date                 -- Sin Ã­ndice (Â¡date range queries!)
```

### Problema de Direcciones (5 campos conflictivos)
```python
candidates.address              # CuÃ¡l es canÃ³nica?
candidates.address_banchi       # ?
candidates.address_building     # ?
candidates.current_address      # ?
candidates.registered_address   # ?
```

---

## âœ… LISTA DE ACCIONES

### SEMANA 1: CRÃTICO (24 horas)
- [ ] **Eliminar credenciales hardcodeadas** (4h)
  - Crear `backend/.env.example`
  - Usar `python-dotenv`
  - Actualizar 12 scripts

- [ ] **Fix SQL Injection** (2h)
  - database.py â†’ usar Table reflection

- [ ] **Fix File Upload Validation** (3h)
  - ValidaciÃ³n de tipo (solo imÃ¡genes)
  - LÃ­mite de tamaÃ±o (10MB mÃ¡x)
  - SanitizaciÃ³n de filename

- [ ] **Cambiar contraseÃ±as por defecto** (1h)
  - Generar aleatorias en setup
  - Solicitar cambio en primer login

- [ ] **Eliminar archivos muertos en raÃ­z** (2h)
  - Mover .py a `backend/scripts/`
  - Mover .bat a `scripts/`

### SEMANA 2: CONSOLIDACIÃ“N (40 horas)
- [ ] **Consolidar imports de fotos** (12h)
  - Crear `unified_photo_import.py`
  - CLI mode: extract, import, verify
  - Dry-run, checkpoint/resume

- [ ] **Consolidar verificaciones** (10h)
  - Crear `verify.py` con subcomandos
  - Eliminar 4 scripts duplicados

- [ ] **Archivar scripts diagnosticados** (5h)
  - Mover a `docs/archive/`
  - Documentar quÃ© hacÃ­a cada uno

- [ ] **Renombrar migrations** (3h)
  - Cambiar a numeraciÃ³n Alembic
  - Verificar orden de ejecuciÃ³n

- [ ] **Limpiar LIXO/** (2h)
  - Revisar si aÃºn necesario
  - Archivar o eliminar

- [ ] **Testing exhaustivo** (8h)

### SEMANA 3: PERFORMANCE (32 horas)
- [ ] **Fix N+1 queries** (8h)
  - Auditar candidatos.py
  - Usar joinedload() sistemÃ¡ticamente

- [ ] **Agregar paginaciÃ³n** (6h)
  - Implementar lÃ­mite/offset
  - Actualizar frontend

- [ ] **Agregar Ã­ndices de BD** (2h)
  - full_name_kanji, full_name_kana
  - hakensaki_shain_id
  - date ranges

- [ ] **Mejorar manejo de errores** (8h)
  - Logging consistente
  - Recovery graceful

- [ ] **DocumentaciÃ³n** (8h)

---

## ğŸ“‹ SCRIPTS A MANTENER

### Backend Scripts (CORE)
```
âœ… MANTENER SIEMPRE:
â”œâ”€â”€ import_data.py                      (Candidatos - PRINCIPAL)
â”œâ”€â”€ import_demo_candidates.py           (Demo data)
â”œâ”€â”€ extract_access_attachments.py       (Extrae fotos - PRINCIPAL)
â”œâ”€â”€ import_photos_from_json.py          (Importa JSON - PRINCIPAL)
â”œâ”€â”€ auto_extract_photos_from_databasejp.py  (Auto-bÃºsqueda)
â”œâ”€â”€ sync_employee_data_advanced.py      (Sincroniza empleados)
â”œâ”€â”€ create_admin_user.py                (Setup inicial)
â”œâ”€â”€ verify_data.py                      (VerificaciÃ³n)
â””â”€â”€ [otros scripts activos no duplicados]

ğŸ—‘ï¸ ELIMINAR:
â”œâ”€â”€ import_photos_by_name.py            (Redundante)
â”œâ”€â”€ import_photos_from_access*.py       (4 versiones redundantes)
â”œâ”€â”€ import_real_candidates*.py          (3 versiones incompletas)
â”œâ”€â”€ import_candidates_*.py              (2 versiones incompletas)
â”œâ”€â”€ verify_*.py                         (Consolidar)
â”œâ”€â”€ debug_*.py                          (5 scripts debug)
â”œâ”€â”€ explore_access_*.py                 (8 diagnÃ³sticos)
â””â”€â”€ [34 mÃ¡s scripts muertos...]
```

---

## ğŸ“Š IMPACTO POST-LIMPIEZA

| MÃ©trica | ANTES | DESPUÃ‰S | MEJORA |
|---------|-------|---------|--------|
| LÃ­neas de cÃ³digo duplicado | 2,500+ | ~200 | **92% â†“** |
| Archivos muertos | 35+ | 0 | **100% â†“** |
| Scripts confusos | 9 | 1 | **89% â†“** |
| Vulnerabilidades crÃ­ticas | 5 | 0 | **100% â†“** |
| PuntuaciÃ³n seguridad | 4/10 | 9/10 | **+125%** |
| Mantenibilidad | 4/10 | 8/10 | **+100%** |

---

## ğŸ¯ RECOMENDACIÃ“N FINAL

**PRIORIDAD 1 (Hacer primero)**: Seguridad crÃ­tica
- Eliminar credenciales hardcodeadas
- Fix SQL injection
- Fix file upload validation
- Cambiar contraseÃ±as dÃ©biles

**PRIORIDAD 2 (Hacer despuÃ©s)**: ConsolidaciÃ³n
- Eliminar duplicados
- Archivar muertos
- Unificar interface

**PRIORIDAD 3 (Nice-to-have)**: OptimizaciÃ³n
- Performance fixes
- Ãndices de BD
- PaginaciÃ³n

---

**Documento generado**: 2025-10-26
**PrÃ³ximo paso**: Empezar con PRIORIDAD 1 (Seguridad)
